# 实施计划：ONES 工时填报网页应用

## 概述

本实施计划将设计转换为可执行的开发任务。应用使用 React + TypeScript + Ant Design 构建，通过 ONES GraphQL API 集成后端服务。实施采用增量方式，每个任务都建立在前一个任务的基础上，确保代码逐步集成。

## 任务

- [x] 1. 项目初始化和基础设施搭建
  - 使用 Vite 创建 React + TypeScript 项目
  - 安装依赖：React Router, Ant Design, Axios, graphql-request, date-fns, fast-check
  - 配置 TypeScript 编译选项
  - 配置 ESLint 和 Prettier
  - 创建基础目录结构（src/components, src/services, src/contexts, src/types, src/utils）
  - _需求: 10.1-10.9_

- [ ] 2. 实现 GraphQL 客户端模块
  - [x] 2.1 创建 GraphQL 客户端接口和实现
    - 实现 GraphQLClient 类，封装 graphql-request
    - 实现 setAuth 和 clearAuth 方法
    - 实现 query 和 mutate 方法
    - 配置请求拦截器，自动添加认证头
    - _需求: 1.6, 10.8, 10.9_
  
  - [ ]* 2.2 编写 GraphQL 客户端单元测试
    - 测试认证头设置
    - 测试端点格式
    - 测试错误处理
    - _需求: 1.6, 10.8_
  
  - [ ]* 2.3 编写属性测试：API 请求认证头
    - **属性 5: API 请求认证头**
    - **验证需求: 1.6, 2.6, 3.5, 4.6, 5.6, 6.8**

- [ ] 3. 实现认证模块
  - [x] 3.1 创建认证服务
    - 实现 AuthService 类
    - 实现 login 方法，调用 ONES 登录 API
    - 实现 logout 方法，清除本地存储
    - 实现 getCurrentUser, isAuthenticated, getAuthToken, getUserId 方法
    - 使用 localStorage 存储认证信息
    - _需求: 1.1, 1.2, 1.3, 1.5, 9.5_
  
  - [x] 3.2 创建认证上下文
    - 实现 AuthContext 和 AuthProvider
    - 提供全局认证状态
    - 实现登录和登出逻辑
    - _需求: 1.1, 1.3_
  
  - [ ]* 3.3 编写认证服务单元测试
    - 测试有效登录
    - 测试无效登录
    - 测试登出清理
    - _需求: 1.1, 1.2, 9.5_
  
  - [ ]* 3.4 编写属性测试：有效登录成功
    - **属性 1: 有效登录成功**
    - **验证需求: 1.1**
  
  - [ ]* 3.5 编写属性测试：无效登录失败
    - **属性 2: 无效登录失败**
    - **验证需求: 1.2**
  
  - [ ]* 3.6 编写属性测试：登录后状态存储
    - **属性 3: 登录后状态存储**
    - **验证需求: 1.3**
  
  - [ ]* 3.7 编写属性测试：登出数据清理
    - **属性 22: 登出数据清理**
    - **验证需求: 9.5**

- [ ] 4. 实现登录页面
  - [x] 4.1 创建登录页面组件
    - 使用 Ant Design Form 组件
    - 实现 email 和 password 输入框
    - 设置 autocomplete="off" 禁用自动填充
    - 设置 password 输入框类型为 password
    - 实现登录按钮和加载状态
    - 显示错误提示
    - _需求: 1.1, 1.2, 1.4, 9.1, 9.2_
  
  - [x] 4.2 集成认证服务
    - 连接 AuthContext
    - 处理登录成功和失败
    - 登录成功后跳转到主界面
    - _需求: 1.1, 1.2, 1.3_
  
  - [ ]* 4.3 编写登录页面单元测试
    - 测试表单渲染
    - 测试 autocomplete 属性
    - 测试错误显示
    - _需求: 1.4, 9.1, 9.2_

- [x] 5. 检查点 - 确保认证功能正常
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 6. 实现任务模块
  - [x] 6.1 创建任务服务
    - 实现 TaskService 类
    - 实现 getTasks 方法，构造 GraphQL 查询
    - 实现 updateTaskStatus 方法，构造 GraphQL 变更
    - 处理 API 错误
    - _需求: 2.1, 2.2, 2.4, 3.1_
  
  - [x] 6.2 创建任务类型定义
    - 定义 Task, TaskFilter, TaskStatus, ProjectStatus 接口
    - _需求: 2.1_
  
  - [ ]* 6.3 编写任务服务单元测试
    - 测试任务查询
    - 测试状态更新
    - 测试错误处理
    - _需求: 2.1, 3.1_
  
  - [ ]* 6.4 编写属性测试：任务查询过滤
    - **属性 6: 任务查询过滤**
    - **验证需求: 2.2, 2.4**
  
  - [ ]* 6.5 编写属性测试：任务状态更新
    - **属性 7: 任务状态更新**
    - **验证需求: 3.1, 3.2**
  
  - [ ]* 6.6 编写属性测试：操作失败状态不变
    - **属性 8: 操作失败状态不变**
    - **验证需求: 3.3, 5.4**

- [ ] 7. 实现工时模块
  - [x] 7.1 创建工时服务
    - 实现 TimesheetService 类
    - 实现 getManhours 方法，构造 GraphQL 查询
    - 实现 submitManhour 方法，构造 GraphQL 变更
    - 实现 getWorkDays 方法，计算工作日（排除周末）
    - _需求: 4.1, 5.1, 6.4_
  
  - [x] 7.2 实现批量工时填报
    - 实现 batchSubmitManhours 方法
    - 实现工时分配逻辑（均分和自定义比例）
    - 实现混合填报逻辑（扣除已填报工时）
    - 实现事务性回滚（失败时撤销所有更改）
    - _需求: 6.1, 6.2, 6.3, 6.5, 6.7_
  
  - [x] 7.3 创建工时类型定义
    - 定义 Manhour, ManhourFilter, ManhourSubmission 等接口
    - _需求: 4.1, 5.1, 6.1_
  
  - [ ]* 7.4 编写工时服务单元测试
    - 测试工时查询
    - 测试手动填报
    - 测试工作日计算
    - 测试批量填报
    - _需求: 4.1, 5.1, 6.1, 6.4_
  
  - [ ]* 7.5 编写属性测试：日期范围工时查询
    - **属性 9: 日期范围工时查询**
    - **验证需求: 4.1**
  
  - [ ]* 7.6 编写属性测试：工时记录完整性
    - **属性 10: 工时记录完整性**
    - **验证需求: 4.2**
  
  - [ ]* 7.7 编写属性测试：手动工时填报
    - **属性 11: 手动工时填报**
    - **验证需求: 5.1**
  
  - [ ]* 7.8 编写属性测试：工时数验证
    - **属性 12: 工时数验证**
    - **验证需求: 5.2**
  
  - [ ]* 7.9 编写属性测试：自动填报工时分配
    - **属性 14: 自动填报工时分配**
    - **验证需求: 6.1, 6.2, 6.3**
  
  - [ ]* 7.10 编写属性测试：工作日过滤
    - **属性 15: 工作日过滤**
    - **验证需求: 6.4**
  
  - [ ]* 7.11 编写属性测试：混合填报工时扣除
    - **属性 16: 混合填报工时扣除**
    - **验证需求: 6.5**
  
  - [ ]* 7.12 编写属性测试：自动填报事务性
    - **属性 17: 自动填报事务性**
    - **验证需求: 6.7**

- [x] 8. 检查点 - 确保核心服务功能正常
  - 确保所有测试通过，如有问题请询问用户。

- [-] 9. 实现主界面布局
  - [-] 9.1 创建主布局组件
    - 使用 Ant Design Layout 组件
    - 实现顶部导航栏，包含模块切换选项
    - 在右上角显示用户姓名
    - 实现主体内容区域
    - _需求: 7.1, 7.2, 7.4_
  
  - [x] 9.2 实现路由配置
    - 使用 React Router 配置路由
    - 实现受保护路由（需要登录）
    - 实现模块切换逻辑
    - _需求: 7.3_
  
  - [ ]* 9.3 编写主布局单元测试
    - 测试导航栏渲染
    - 测试用户信息显示
    - 测试路由切换
    - _需求: 7.2, 7.3, 7.4_
  
  - [ ]* 9.4 编写属性测试：模块导航
    - **属性 18: 模块导航**
    - **验证需求: 7.3**
  
  - [ ]* 9.5 编写属性测试：用户信息显示
    - **属性 19: 用户信息显示**
    - **验证需求: 7.4**

- [ ] 10. 实现任务查询面板
  - [x] 10.1 创建任务查询组件
    - 使用 Ant Design Table 显示任务列表
    - 实现状态筛选器（多选）
    - 默认选中"进行中"状态
    - 显示任务名称、状态、项目、负责人等信息
    - 处理加载状态和错误状态
    - 显示空状态提示
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_
  
  - [ ]* 10.2 编写任务查询面板单元测试
    - 测试表格渲染
    - 测试筛选器
    - 测试默认状态
    - 测试空状态
    - _需求: 2.2, 2.3, 2.5_

- [ ] 11. 实现任务操作面板
  - [x] 11.1 创建任务操作组件
    - 复用任务查询组件的任务列表
    - 为每个任务添加状态下拉选择器
    - 实现状态更新功能
    - 显示更新成功/失败提示
    - 处理网络错误
    - _需求: 3.1, 3.2, 3.3, 3.4_
  
  - [ ]* 11.2 编写任务操作面板单元测试
    - 测试状态选择器
    - 测试状态更新
    - 测试错误处理
    - _需求: 3.1, 3.3, 3.4_

- [ ] 12. 实现工时查询面板
  - [x] 12.1 创建工时查询组件
    - 使用 Ant Design DatePicker 选择日期范围
    - 使用 Ant Design Table 显示工时记录
    - 显示任务名称、日期、工时数
    - 同时显示任务列表和对应工时
    - 处理加载状态和错误状态
    - 显示空状态提示
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_
  
  - [ ]* 12.2 编写工时查询面板单元测试
    - 测试日期选择器
    - 测试表格渲染
    - 测试空状态
    - 测试错误处理
    - _需求: 4.1, 4.4, 4.5_

- [ ] 13. 实现工时填报面板
  - [x] 13.1 创建手动填报组件
    - 使用 Ant Design Calendar 显示月视图
    - 为每个日期显示输入框
    - 实现任务选择器
    - 实现工时输入和验证（正数）
    - 实现提交功能
    - 显示已填报的工时
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_
  
  - [x] 13.2 创建自动填报组件
    - 实现总工时输入
    - 实现任务选择器（多选）
    - 实现日期范围选择器
    - 实现分摊比例配置（可选）
    - 默认均分选项
    - 显示已手动填报的工时
    - 计算剩余工时
    - 实现批量提交功能
    - 显示填报结果摘要
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_
  
  - [x] 13.3 实现模式切换
    - 实现手动/自动模式切换
    - 保持各模式的状态
    - _需求: 5.1, 6.1_
  
  - [ ]* 13.4 编写工时填报面板单元测试
    - 测试手动填报
    - 测试自动填报
    - 测试工时验证
    - 测试模式切换
    - _需求: 5.1, 5.2, 6.1, 6.2_
  
  - [ ]* 13.5 编写属性测试：月视图日期完整性
    - **属性 13: 月视图日期完整性**
    - **验证需求: 5.5**

- [x] 14. 检查点 - 确保所有 UI 组件正常
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 15. 实现错误处理
  - [x] 15.1 创建错误处理服务
    - 实现 NetworkErrorHandler
    - 实现 AuthErrorHandler
    - 实现 BusinessErrorHandler
    - 实现 SystemErrorHandler
    - 实现重试机制
    - _需求: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_
  
  - [x] 15.2 创建 Error Boundary 组件
    - 实现 React Error Boundary
    - 捕获组件渲染错误
    - 显示错误 UI
    - 记录错误日志
    - _需求: 8.4_
  
  - [x] 15.3 集成错误处理到所有服务
    - 在 GraphQL 客户端中集成错误处理
    - 在所有服务中添加错误处理
    - 统一错误提示样式
    - _需求: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_
  
  - [ ]* 15.4 编写错误处理单元测试
    - 测试各类错误处理
    - 测试重试机制
    - 测试 Error Boundary
    - _需求: 8.1, 8.2, 8.3, 8.4_
  
  - [ ]* 15.5 编写属性测试：API 错误处理
    - **属性 20: API 错误处理**
    - **验证需求: 8.1, 8.4**
  
  - [ ]* 15.6 编写属性测试：会话过期状态保留
    - **属性 21: 会话过期状态保留**
    - **验证需求: 8.5**

- [ ] 16. 实现会话管理
  - [x] 16.1 实现会话过期检测
    - 监听 401 错误
    - 提示用户重新登录
    - 保留当前页面状态
    - _需求: 1.5, 8.5, 8.6_
  
  - [x] 16.2 实现自动登出
    - 会话过期时清除认证信息
    - 重定向到登录页
    - _需求: 1.5, 8.6, 9.5_
  
  - [ ]* 16.3 编写会话管理单元测试
    - 测试会话过期检测
    - 测试自动登出
    - 测试状态保留
    - _需求: 1.5, 8.5, 8.6_
  
  - [ ]* 16.4 编写属性测试：会话过期处理
    - **属性 4: 会话过期处理**
    - **验证需求: 1.5**

- [ ] 17. 实现 API 响应验证
  - [x] 17.1 创建响应验证器
    - 实现数据格式验证
    - 检测响应结构错误
    - 报告格式错误
    - _需求: 10.6, 10.7_
  
  - [x] 17.2 集成响应验证到 GraphQL 客户端
    - 在所有 API 响应中添加验证
    - 处理验证失败
    - _需求: 10.6, 10.7_
  
  - [ ]* 17.3 编写响应验证单元测试
    - 测试有效响应
    - 测试无效响应
    - 测试错误报告
    - _需求: 10.6, 10.7_
  
  - [ ]* 17.4 编写属性测试：GraphQL 端点格式
    - **属性 23: GraphQL 端点格式**
    - **验证需求: 10.8**
  
  - [ ]* 17.5 编写属性测试：GraphQL 请求格式
    - **属性 24: GraphQL 请求格式**
    - **验证需求: 10.9**
  
  - [ ]* 17.6 编写属性测试：API 响应格式验证
    - **属性 25: API 响应格式验证**
    - **验证需求: 10.7**

- [ ] 18. 最终集成和测试
  - [x] 18.1 集成所有模块
    - 确保所有组件正确连接
    - 测试完整的用户流程
    - 修复集成问题
    - _需求: 所有需求_
  
  - [x] 18.2 优化性能
    - 实现组件懒加载
    - 优化 API 请求
    - 添加加载状态
    - _需求: 7.5_
  
  - [x] 18.3 优化用户体验
    - 统一样式和交互
    - 添加过渡动画
    - 优化错误提示
    - _需求: 7.5_
  
  - [ ]* 18.4 运行所有测试
    - 运行所有单元测试
    - 运行所有属性测试
    - 确保测试覆盖率达标
    - _需求: 所有需求_

- [x] 19. 最终检查点 - 确保应用完整可用
  - 确保所有测试通过，应用可以正常运行，如有问题请询问用户。

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号，确保可追溯性
- 检查点任务确保增量验证
- 属性测试使用 fast-check 库，每个测试至少运行 100 次迭代
- 所有属性测试都使用标签格式：**Feature: ones-timesheet-app, Property {number}: {property_text}**
